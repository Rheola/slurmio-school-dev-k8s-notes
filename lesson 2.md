---
date created: 2021-10-05 19:29:55 (+03:00), Tuesday
---
# [Запись урока](https://www.youtube.com/watch?v=V6aGfrMXhbA) на youtube

# Pod
- [Документация](https://kubernetes.io/docs/concepts/workloads/pods/)
- Pod — не аббревиатура, в переводе "стручок" (горошины — [контейнеры](https://kubernetes.io/docs/concepts/containers/))
- Как правило, является одним инстансом запущенного приложения, сервиса, микросервиса
- Если `kubernetes` воспринимать не только как систему оркестрации контейнеров, а как кластерную ОС, то `pod` можно воспринимать как процесс (это метафора, аналогия, не стоит воспринимать буквально, [начало обсуждения на эту тему](https://t.me/c/1540117827/17176))
- Является минимальной абстракцией `kubernetes` (как правило, внутри него 2 контейнера, иногда больше)
    - Один из контейнеров — приложение
    - Второй — имеет в имени "POD", несёт в себе сетевой неймспейс (`network namespace`) для данного pod
    - Контейнеры в рамках одного pod могут ходить к друг другу в рамках `localhost`
    - Контейнер в рамках pod существует в рамках одной ноды `kubernetes`
    - Несколько контейнеров в одном pod могут быть нужны:
        - если нужно держать их на одной ноде (физической или виртуальной машине)
        - если масштабируется линейно, например 1 к 1
        - если компоненты имеют сильную связь, например:
            - `prometheus` и `config reloader` для него
            - Инструменты мониторинга, такие как экспортеры prometheus, экспортеры и приложения в одном pod'е
            - Авторизующие сервисы (прокси) для приложений
            - Сервис-меши — в рамках всех pod'ов добавляется сервис-меш прокся

# Из ответов на вопросы:
- По умолчанию волюмы для контейнеров внутри пода подключаются свои, но при желании можно общие, это отдельная история
- Если перефразировать — пространство ОС между контейнерами не шарится


- Q: Внутри `kubernetes` поды образуют свою сеть? То есть для похода из одного пода в другой нужно ходить по сети kubernetes, а не просто по локалхосту?
- A: Сходить из одного контейнера в другой можно, но уже поверх сети, которую предоставляет кластер kubernetes, не через локальную петлю
- [virtlet](https://github.com/Mirantis/virtlet) — проект, основанный на kubernetes, позволяет работать не с контейнерами, а с qcow виртуальными машинами

# Практика:
- факультатив — поразбираться с yaml (например [1](https://yaml.org/), [2](https://habr.com/ru/company/rambler_and_co/blog/525498/)), прочитать документацию (4 абзаца), дойти до анхоров (anchors?) понять что они не нужны и на этом остановиться. Важно научиться на глаз отличать словарь от списка
- "---" в yaml — обозначение начала документа (абстракции) в рамках файла, каждый такой набор означает начало нового документа
- "..." — конец документа, как я понял, не обязателен и служит для лучшего понимания структуры документов людьми, особенно, при передаче в чатах и т.п.

Центральный компонент kubernetes — API сервер, всё происходит через него, общение по протоколу REST (подсказывают, что это не протокол, в данном случае протокол это HTTP), в примере ниже идёт указание версии API. Это важно, т.к. обычно изменения внедряются в других версиях API и работа с сущностями в разных версиях API может отличаться.

Склонировали содержимое https://github.com/Slurmio/school-dev-k8s, работаем в `practice/2.application-abstractions/1.pod`, его содержимое с комментариями:
```yaml
---
# file: practice/2.application-abstractions/1.pod/pod.yaml
apiVersion: v1 # версия апи
kind: pod # тип описываемого объекта
metadata: # раздел с дополнительной информацией
  name: my-pod # указываем имя
spec: # описываем детали че будет внутри
  containers:
  - image: quay.io/testing-farm/nginx:1.12
    name: nginx
    ports: # в данном случае это не директива, а документирование
    - containerPort: 80
...
```

создаём pod из такого файла:
```shell
kubectl create -f pod.yaml
```

Команда
```shell
kubectl get pod
```
Выдаст следующий результат:
```shell output
NAME     READY   STATUS    RESTARTS   AGE
my-pod   1/1     Running   0          108s
```

- READY — это количество реплик, в реалиях kubernetes не запускают поды вручную штучно, далее в вебинарах будут абстракции выше [deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/), [replicaset](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/)
- RESTARTS — kubernetes может автоматически перезапускать pod в случае проблем, данный счётчик позволяет это отслеживать

- kubectl поддерживает сокращения, например pod => po
- для удобства можно сделать алиас для kubectl, пример для linux:
```shell
alias k="kubectl"
```
- В рамках одного пространства имен в kubernetes не может существовать 2 объекта одного типа с одним именем
- С точки зрения разраба не стоит думать о физических сущностях, как и где что-то работает (с точки зрения эксплуатации - стоит)

команда
```shell
kubectl describe
```
позволяет посмотреть описание объекта, что о нем знает kubernetes, пример:
```shell
kubectl describe pod my-pod
```

Удаляем созданные в ходе практики поды (в учебном кластере крайне желательно убирать за собой, убивать поды и т.п., если оно не используется):
```shell
kubectl delete pod my-pod # с указанием типа и имени
kubectl delete -f pod.yaml # через файл, с помощью которого производили создание объекта
kubectl delete pod --all # подсказывают в чате, проверил работает
```

# Вопросы:
- |
    - Q: Что будет если указать одинаковые порты для 2х контейнеров в поде
    - A: Пробуйте и расскажите мне
        - В чате говорят — если 2 порта одинаковые — один из контейнеров не стартует
- |
    - Q: Разница между kubectl create и kubectl apply?
    - A: Ответ можно найти в telegram чате, а также в [3й лекции](lesson%203.md#Разница-между-create-и-apply)
- |
    - Q: Как узнать что наши указания выполнены, контейнер поднялся и работает нужным образом и т.п.
    - A: Всё как в докере, можно войти в контейнер (kubectl exec и т.п.)
- |
    - Q: Как локально сделать то же самое что было на практике?
    - ФЖ D kjrfkmyjv bycnfyct dc\ ,eltn hf,jnfnm nfr ;t
- |
    - Q: Можно ли настроить приложения на работу с одними и теми же портами?
    - A: В рамках pod одно общее сетевое пространство и интерфейсы, то есть нельзя открыть 2 одинаковых порта или задействовать 2 IP адреса
- |
    - Q: Как взамимодействовать с контейнерами?
    - A: Дебаг, логи — в след раз, но в целом всё как в докере — `exec, logs`
        - `kubectl get logs` -  берет логи из stdout и sderr контейнера
        - `kubectl describe pod pod-name`- расширенная инфа
- |
    - Q: openshift vs kubernetes
    - A: если кратко и цензурно — проприетарщина vs OSS, openshift, rancher построены на базе kubernetes (мысль была шире)
- |
    - Q: Как настроить терминал как у ведущего?
    - A: В [github Павла Селиванова](https://github.com/pauljamm/dotfiles) можно это найти
- |
    - Q: Если мы запускаем несколько контейнеров в поде, будет ли запускаться несколько POD_контейнеров_1oaj2890j? 
    - A: Он всегда 1
- |
    - Q: Отличия pod от ноды
    - A: 
        - Pod — минимальная ШТУКА (читай абстракция) в которой может быть один или несколько контейнеров в зависимости от того, как ВАМ это потребуется в текущей задаче, запущенная на ЕДИНСТВЕННОЙ ноде в текущем моменте времени
        - Node (нода) — узел, на котором запускается pod. Виртуалка, железный сервер, etc. У нод бывают разные роли. Об этом будет дальше скорее всего
- |
    - Q: как инициализация настроек произошла на тачке? Как он знает куда ходить?
    - A: Через конфиг который вам пришёл в личном кабинете. Рекомендую посмотреть курс бесплатный в Слёрме MKS. Будет понятнее
- |
    - Q: А кроме портов можно еще какие-то метаданные указать в YAML для pod?
    - A: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#podspec-v1-core
- |
    - Q: Не понял сейчас, сначала говорил, что ports в описании это только для документации,  а теперь нельзя создать два  контейнера с одинаковым портом в этом поле
    - A: Все правильно, в документации порты — описательные, но указанные в yaml образы используют реально для старта один 80 порт, соответственно, если нужно вдруг теоретически два nginx нужно сделать образ с другим портом
# Всякое из чата:
- [Kubernetes — изучаем паттерн Sidecar](https://habr.com/ru/company/nixys/blog/559368/)
- [Иллюстрированное руководство по Kubernetes для детей, The Illustrated Children's Guide to Kubernetes](https://www.youtube.com/watch?v=4ht22ReBjno)
- [Обзор Lens — IDE для Kubernetes](https://habr.com/ru/company/flant/blog/563422/)
- Если кому-то интересны альтернативные решения для подсветки синтаксиса в vim, обратите внимание на [этот тул](https://github.com/NvChad/NvChad). Он гибкий, супербыстрый и совмещает в себе почти все функции современных IDE, при этом являясь тонким клиентом. [Скрин моего экрана NvChad](https://pasteboard.co/CVy5ESak2MQD.png). И [пример](https://github.com/saequus/mac-conf/blob/master/.vimrc) моих сеттингов для vim
- [github/indrabasak/Books/Kubernetes in Action.pdf](https://github.com/indrabasak/Books/blob/master/Kubernetes%20in%20Action.pdf)
